#!/usr/bin/env ruby

require 'eventmachine'
require_relative '../lib/stream_watcher'
require_relative '../lib/intelligentli'

lambda {
  ili = nil
  watchers = []

  Kernel.send :define_method, :login do |*args|
    ili = Intelligentli.new *args
  end

  Kernel.send :define_method, :watch do |uri, options = {}, &block|
    watchers << Proc.new { StreamWatcher.new(ili, uri, options, block).run }
  end

  Kernel.send :define_method, :run do
    EM.run { watchers.each(&:call) }
  end
}.call

load ARGV[0]

run
